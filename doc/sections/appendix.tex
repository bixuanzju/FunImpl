%%% !!! WARNING: AUTO GENERATED. DO NOT MODIFY !!! %%%
\section{Full Specification of Core Language}

\subsection{Syntax}
\gram{\otte\ottinterrule
        \ottG\ottinterrule
        \ottv}
\[
    \begin{array}{llll}
     \text{Syntactic Sugar}\\
     \quad T_{{\mathrm{1}}}  \rightarrow  T_{{\mathrm{2}}} & \triangleq & \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}} \quad x \not \in \FV(T_{{\mathrm{2}}}) \\
     \quad \ottsym{(}  \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{)}  \rightarrow  T_{{\mathrm{2}}} & \triangleq & \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}} \quad x \in \FV(T_{{\mathrm{2}}}) \\
     \quad \kw{cast}_{\uparrow}^n \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e} &  \triangleq ~  &  \kw{cast}^{\uparrow}  [ \tau_{{\mathrm{1}}} ] ( \kw{cast}^{\uparrow}  [ \tau_{{\mathrm{2}}} ] (\dots ( \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{\ottmv{n}}  \ottsym{]} \,  \ottnt{e} ) \dots )) \\
     \quad \kw{cast}_{\downarrow}^n \, \ottnt{e} &  \triangleq ~  & \underbrace{ \kw{cast}_{\downarrow}  ( \kw{cast}_{\downarrow}  (\dots (  \kw{cast}_{\downarrow} }_n \ottnt{e}) \dots ))
    \end{array}
\]

\subsection{Operational Semantics}
\ottdefnstep{}
\ottusedrule{\ottdruleSXXMu{}}

\subsection{Typing}
\ottdefnctx{}
\ottdefnexpr{}
\ottusedrule{\ottdruleTXXMu{}}

\section{Proofs about Core Language}
\subsection{Properties}
\begin{lem}[Free variable lemma]\label{lem:appendix:free}
    If $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$, then $\FV(e) \subseteq \dom(\Gamma)$ and $\FV(\tau) \subseteq \dom(\Gamma)$.
\end{lem}

\begin{proof}
    By induction on the derivation of $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$. We only treat cases \ruleref{T\_Mu}, \ruleref{T\_CastUp} and \ruleref{T\_CastDown} (since proofs of other cases are the same as \cc \cite{handbook}):
    \begin{description}
        \item[Case \ruleref{T\_Mu}:] From premises of $\Gamma  \vdash  \ottsym{(}  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  \ottsym{:}  \tau$, by induction hypothesis, we have $\FV(e_1) \subseteq \dom(\Gamma) \cup \{\ottmv{x}\}$ and $\FV(\tau) \subseteq \dom(\Gamma)$. Thus the result follows by $\FV(\mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}})=\FV(e_1) \setminus \{\ottmv{x}\} \subseteq \dom(\Gamma)$ and $\FV(\tau) \subseteq \dom(\Gamma)$.
        \item[Case \ruleref{T\_CastUp}:] Since $\FV(\kw{cast}^{\uparrow} \, \ottsym{[}  \tau  \ottsym{]} \,  \ottnt{e_{{\mathrm{1}}}})=\FV(\ottnt{e_{{\mathrm{1}}}})$, the result follows directly by the induction hypothesis.
        \item[Case \ruleref{T\_CastDown}:] Since $\FV(\kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}})=\FV(\ottnt{e_{{\mathrm{1}}}})$, the result follows directly by the induction hypothesis.
    \end{description}
\end{proof}

\begin{lem}[Thinning lemma]\label{lem:appendix:thin}
    Let $\Gamma$ and $\Gamma'$ be legal contexts such that $\Gamma \subseteq \Gamma'$. If $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$ then $\Gamma'  \vdash  \ottnt{e}  \ottsym{:}  \tau$.
\end{lem}

\begin{proof}
    By trivial induction on the derivation of $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$.
\end{proof}

\begin{lem}[Substitution lemma]\label{lem:appendix:subst}
	If $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau$ and $\Gamma_{{\mathrm{1}}}  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \sigma$, then $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,  \ottsym{:}  \tau  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$.
\end{lem}

\begin{proof}
    By induction on the derivation of $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau$. Let $\ottnt{e}  ^{*}  \equiv  \ottnt{e}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$. Then the result can be written as $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{:}  \tau  ^{*}$. We only treat cases \ruleref{T\_Mu}, \ruleref{T\_CastUp} and \ruleref{T\_CastDown}. Consider the last step of derivation of the following cases:
    \begin{description}
        \item[Case \ruleref{T\_Mu}:] $\inferrule{\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau \\ \Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \tau  \ottsym{:}  \star}{\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottsym{(}  \mu \, \ottmv{y}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  \ottsym{:}  \tau}$ 
        
        By induction hypothesis, we have $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{:}  \tau  ^{*}$ and $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \tau  ^{*}  \ottsym{:}  \star$. Then by the deviation rule, $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottsym{(}  \mu \, \ottmv{y}  \ottsym{:}  \tau  ^{*}  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{)}  \ottsym{:}  \tau  ^{*}$. Thus we have $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottsym{(}  \mu \, \ottmv{y}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  ^{*}  \ottsym{:}  \tau  ^{*}$ which is just the result.
        \item[Case \ruleref{T\_CastUp}:] $\inferrule{\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{2}}} \\ \Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \tau_{{\mathrm{1}}}  \ottsym{:}  \star \\ \tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}}{\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  \ottsym{:}  \tau_{{\mathrm{1}}}}$ 
        
        By induction hypothesis, we have $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{:}  \tau_{{\mathrm{2}}}  ^{*}$, $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \tau_{{\mathrm{1}}}  ^{*}  \ottsym{:}  \star$ and $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$. By the definition of substitution, we can obtain $\tau_{{\mathrm{1}}}  ^{*}  \longrightarrow  \tau_{{\mathrm{2}}}  ^{*}$ by $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$. Then by the deviation rule, $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  ^{*}  \ottsym{]} \,  \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{)}  \ottsym{:}  \tau_{{\mathrm{1}}}  ^{*}$. Thus we have $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  ^{*}  \ottsym{:}  \tau_{{\mathrm{1}}}  ^{*}$ which is just the result.
        \item[Case \ruleref{T\_CastDown}:] $\inferrule{\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{1}}} \\ \Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \tau_{{\mathrm{2}}}  \ottsym{:}  \star \\ \tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}}{\Gamma_{{\mathrm{1}}}  \ottsym{,}  \ottmv{x}  \ottsym{:}  \sigma  \ottsym{,}  \Gamma_{{\mathrm{2}}}  \vdash  \ottsym{(}  \kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  \ottsym{:}  \tau_{{\mathrm{2}}}}$ 
        
        By induction hypothesis, we have $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{:}  \tau_{{\mathrm{1}}}  ^{*}$, $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \tau_{{\mathrm{2}}}  ^{*}  \ottsym{:}  \star$ and $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$ thus $\tau_{{\mathrm{1}}}  ^{*}  \longrightarrow  \tau_{{\mathrm{2}}}  ^{*}$. Then by the deviation rule, $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottsym{(}  \kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}  ^{*}  \ottsym{)}  \ottsym{:}  \tau_{{\mathrm{2}}}  ^{*}$. Thus we have $\Gamma_{{\mathrm{1}}}  \ottsym{,}  \Gamma_{{\mathrm{2}}}  ^{*}  \vdash  \ottsym{(}  \kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  ^{*}  \ottsym{:}  \tau_{{\mathrm{2}}}  ^{*}$ which is just the result.
    \end{description}
\end{proof}

\begin{lem}[Generation lemma]\label{lem:appendix:gen}
$\quad$
\begin{enumerate}[(1)]
	\item If $\Gamma  \vdash  \ottmv{x}  \ottsym{:}  \sigma$, then there exist an expression $\tau$ such that $\tau  \equiv  \sigma$, $\Gamma  \vdash  \tau  \ottsym{:}  \star$ and $\ottmv{x}  \ottsym{:}  \tau \, \in \, \Gamma$.
	\item If $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \sigma$, then there exist expressions $\tau_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}$ such that $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}$, $\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}$ and $\sigma  \equiv  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$.
	\item If $\Gamma  \vdash  \ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e}  \ottsym{)}  \ottsym{:}  \sigma$, then there exist an expression $\tau_{{\mathrm{2}}}$ such that $\sigma  \equiv  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}$ where $\Gamma  \vdash  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}  \ottsym{:}  \star$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{2}}}$.
    \item If $\Gamma  \vdash  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}  \ottsym{:}  \sigma$, then $\sigma  \equiv  \star$, $\Gamma  \vdash  \tau_{{\mathrm{1}}}  \ottsym{:}  \star$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \tau_{{\mathrm{2}}}  \ottsym{:}  \star$.
	\item If $\Gamma  \vdash  \ottsym{(}  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{)}  \ottsym{:}  \sigma$, then $\Gamma  \vdash  \tau  \ottsym{:}  \star$, $\sigma  \equiv  \tau$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau  \vdash  \ottnt{e}  \ottsym{:}  \tau$.
	\item If $\Gamma  \vdash  \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e}  \ottsym{)}  \ottsym{:}  \sigma$, then there exist an expression $\tau_{{\mathrm{2}}}$ such that $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{2}}}$, $\Gamma  \vdash  \tau_{{\mathrm{1}}}  \ottsym{:}  \star$, $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$ and $\sigma  \equiv  \tau_{{\mathrm{1}}}$.
	\item If $\Gamma  \vdash  \ottsym{(}  \kw{cast}_{\downarrow} \, \ottnt{e}  \ottsym{)}  \ottsym{:}  \sigma$, then there exist expressions $\tau_{{\mathrm{1}}},\tau_{{\mathrm{2}}}$ such that $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{1}}}$, $\Gamma  \vdash  \tau_{{\mathrm{2}}}  \ottsym{:}  \star$, $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$ and $\sigma  \equiv  \tau_{{\mathrm{2}}}$.
\end{enumerate}
\end{lem}

\begin{proof}
    Consider a derivation of $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \sigma$ for one of cases in the lemma. We can follow the process of derivation until expression $\ottnt{e}$ is introduced the first time. The last step of derivation can be done by
    \begin{itemize}
        \item rule \ruleref{T\_Var} for case 1;
        \item rule \ruleref{T\_App} for case 2;
        \item rule \ruleref{T\_Lam} for case 3;
        \item rule \ruleref{T\_Pi} for case 4;
        \item rule \ruleref{T\_Mu} for case 5;
        \item rule \ruleref{T\_CastUp} for case 6;
        \item rule \ruleref{T\_CastDown} for case 7.
    \end{itemize}
    In each case, assume the conclusion of the rule is $\Gamma'  \vdash  \ottnt{e}  \ottsym{:}  \tau'$ where $\Gamma' \subseteq \Gamma$ and $\tau'  \equiv  \sigma$. Then by inspection of used derivation rules and Lemma \ref{lem:appendix:thin}, it can be shown that the statement of the lemma holds and is the only possible case.
\end{proof}

\begin{lem}[Correctness of types]\label{lem:appendix:corrtyp}
    If $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$ then $\tau  \equiv  \star$ or $\Gamma  \vdash  \tau  \ottsym{:}  \star$.
\end{lem}

\begin{proof}
    Trivial induction on the derivation of $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$ using Lemma \ref{lem:appendix:gen}.
\end{proof}

\subsection{Decidability of Type Checking}
\begin{lem}[Uniqueness of one-step reduction]\label{lem:appendix:unired}
	The relation $ \longrightarrow $, i.e. one-step reduction, is unique in the sense that given $\ottnt{e}$ there is at most one $\ottnt{e'}$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
\end{lem}

\begin{proof}
	By induction on the structure of $\ottnt{e}$:
	\begin{description}
		\item[Case $\ottnt{e}  \ottsym{=}  \ottnt{v}$:] $\ottnt{e}$ has one of the following forms:
		\begin{inparaenum}[(1)]
		    \item $\star$,
			\item $\lambda  \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}$,
			\item $\Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}$,
			\item $\kw{cast}^{\uparrow} \, \ottsym{[}  \tau  \ottsym{]} \,  \ottnt{e}$,
		\end{inparaenum}
		which cannot match any rules of $ \longrightarrow $. Thus there is no $\ottnt{e}'$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
		\item[Case $\ottnt{e}=\ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)} \, \ottnt{e_{{\mathrm{2}}}}$:] There is a unique $\ottnt{e}'=\ottnt{e_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$ by rule \ruleref{S\_Beta}.
		\item[Case $\ottnt{e}=\kw{cast}_{\downarrow} \, \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau  \ottsym{]} \,  \ottnt{e}  \ottsym{)}$:] There is a unique $\ottnt{e}'=e$ by rule \ruleref{S\_CastDownUp}.
		\item[Case $\ottnt{e}=\mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}$:] There is a unique $\ottnt{e}'=\ottnt{e}  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{]} \,$ by rule \ruleref{S\_Mu}.
		\item[Case $\ottnt{e}=\ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}$ and $\ottnt{e_{{\mathrm{1}}}}$ is not a $\lambda$-term:] If $\ottnt{e_{{\mathrm{1}}}}=v$, there is no $\ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. Since $\ottnt{e_{{\mathrm{1}}}}$ is not a $\lambda$-term, there is no rule to reduce $\ottnt{e}$. Thus there is no $\ottnt{e}'$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
		
		Otherwise, there exists some $\ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. By the induction hypothesis, $\ottnt{e'_{{\mathrm{1}}}}$ is unique reduction of $\ottnt{e_{{\mathrm{1}}}}$. Thus by rule \ruleref{S\_App}, $\ottnt{e}'=\ottnt{e'_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}$ is the unique reduction for $\ottnt{e}$.
		\item[Case $\ottnt{e}=\kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}$ and $\ottnt{e_{{\mathrm{1}}}}$ is not a $ \kw{cast}^{\uparrow} $-term:] If $\ottnt{e_{{\mathrm{1}}}}=v$, there is no $\ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. Since $\ottnt{e_{{\mathrm{1}}}}$ is not a $ \kw{cast}^{\uparrow} $-term, there is no rule to reduce $\ottnt{e}$. Thus there is no $\ottnt{e}'$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
		
		Otherwise, there exists some $\ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. By the induction hypothesis, $\ottnt{e'_{{\mathrm{1}}}}$ is unique reduction of $\ottnt{e_{{\mathrm{1}}}}$. Thus by rule \ruleref{S\_CastDown}, $\ottnt{e}'=\kw{cast}_{\downarrow} \, \ottnt{e'_{{\mathrm{1}}}}$ is the unique reduction for $\ottnt{e}$.
	\end{description}
\end{proof}

\begin{lem}[Uniqueness of $n$-step reduction]\label{lem:appendix:uniquen}
	The $n$-step reduction $ \longrightarrow_n $ is unique in the sense that given $\ottnt{e}$ there is at most one $\ottnt{e'}$ such that $\ottnt{e}  \longrightarrow_n  \ottnt{e'}$.
\end{lem}

\begin{proof}
	Immediate from Lemma \ref{lem:appendix:unired}, by induction on the number of reduction steps.
\end{proof}

\begin{lem}[Decidability of type checking]
	There is a decidable algorithm which given $\Gamma, \ottnt{e}$ computes the unique $\tau$ such that $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$ or reports there is no such $\tau$.
\end{lem}

\begin{proof}
	By induction on the structure of $\ottnt{e}$:
	\begin{description}
	    \item[Case $\ottnt{e}  \ottsym{=}  \star$:] Trivial by applying \ruleref{T\_Ax} and $\tau  \equiv  \star$.
		\item[Case $\ottnt{e}  \ottsym{=}  \ottmv{x}$:] Trivial by rule \ruleref{T\_Var} and $\tau$ is the unique type of $\ottmv{x}$ if $\ottmv{x}  \ottsym{:}  \tau \, \in \, \Gamma$.
		\item[Case $\ottnt{e}=\ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}$:] By rule \ruleref{T\_App} and introduction hypothesis, there exist unique expressions $\tau_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}$ such that $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}$, $\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}$. Thus, from Lemma \ref{lem:appendix:gen}, $\tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$ is the unique type of $\ottnt{e}$.
		\item[Case $\lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}$:] By rule \ruleref{T\_Lam} and introduction hypothesis, there exist unique expressions $\tau_{{\mathrm{2}}}$ such that $\Gamma  \vdash  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}  \ottsym{:}  \star$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{2}}}$. Thus, from Lemma \ref{lem:appendix:gen}, $\Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}$ is the unique type of $\ottnt{e}$.
		\item[Case $\Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}$:] By rule \ruleref{T\_Pi} and introduction hypothesis, we have $\Gamma  \vdash  \tau_{{\mathrm{1}}}  \ottsym{:}  \star$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \tau_{{\mathrm{2}}}  \ottsym{:}  \star$. Thus, from Lemma \ref{lem:appendix:gen}, $\star$ is the unique type of $\ottnt{e}$.
		\item[Case $\mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}$:] By rule \ruleref{T\_Mu} and introduction hypothesis, we have $\Gamma  \vdash  \tau  \ottsym{:}  \star$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau  \vdash  \ottnt{e}  \ottsym{:}  \tau$. Thus, from Lemma \ref{lem:appendix:gen}, $\tau$ is the unique type of $\ottnt{e}$.
		\item[Case $\ottnt{e}=\kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e_{{\mathrm{1}}}}$:] From the premises of rule \ruleref{T\_CastUp}, by induction hypothesis, we can derive the type of $\ottnt{e_{{\mathrm{1}}}}$ as $\tau_{{\mathrm{2}}}$, and check whether $\tau_{{\mathrm{1}}}$ is legal, i.e. its sorts is $\star$. If $\tau_{{\mathrm{1}}}$ is legal, by Lemma \ref{lem:appendix:unired}, there is at most one $\tau'_{{\mathrm{1}}}$ such that $\tau_{{\mathrm{1}}}  \longrightarrow  \tau'_{{\mathrm{1}}}$. If such $\tau'_{{\mathrm{1}}}$ does not exist, then we report type checking fails. Otherwise, we examine if $\tau'_{{\mathrm{1}}}$ is syntactically equal to $\tau_{{\mathrm{2}}}$, i.e. $\tau'_{{\mathrm{1}}}  \equiv  \tau_{{\mathrm{2}}}$. If the equality holds, we obtain the unique type of $\ottnt{e}$ which is $\tau_{{\mathrm{1}}}$. Otherwise, we report $\ottnt{e}$ fails to type check.
		\item[Case $\ottnt{e}=\kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}$:] From the premises of rule \ruleref{T\_CastDown}, by induction hypothesis, we can derive the type of $\ottnt{e_{{\mathrm{1}}}}$ as $\tau_{{\mathrm{1}}}$. By Lemma \ref{lem:appendix:unired}, there is at most one $\tau_{{\mathrm{2}}}$ such that $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$. If such $\tau_{{\mathrm{2}}}$ exists and its sorts is $\star$, we have found the unique type of $\ottnt{e}$ is $\tau_{{\mathrm{2}}}$. Otherwise, we report $\ottnt{e}$ fails to type check.
	\end{description}
\end{proof}

\subsection{Soundness}
\begin{dfn}[Multi-step reduction]
    The relation $ \twoheadrightarrow $ is the transitive and reflexive closure of $ \longrightarrow $.
\end{dfn}

\begin{lem}[Subject reduction]
If $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \sigma$ and $\ottnt{e}  \twoheadrightarrow  e'$ then $\Gamma  \vdash  \ottnt{e'}  \ottsym{:}  \sigma$.
\end{lem}

\begin{proof}
    We prove the case for one-step reduction, i.e. $\ottnt{e}  \longrightarrow  \ottnt{e'}$. The lemma can follow by induction on the number of one-step reductions of $\ottnt{e}  \twoheadrightarrow  \ottnt{e'}$.
    The proof is by induction with respect to the definition of one-step reduction $ \longrightarrow $ as follows:
    \begin{description}
        \item[Case $\ottdruleSXXBeta{}$:] $\quad$ \\
        Suppose $\Gamma  \vdash  \ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)} \, \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \sigma$ and $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,  \ottsym{:}  \sigma'$. By Lemma \ref{lem:appendix:gen}(2), there exist expressions $\tau'_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}$ such that 
        \begin{align}
            &\Gamma  \vdash  \ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{)}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau'_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)} \label{equ:lam} \\
            &\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau'_{{\mathrm{1}}} \nonumber \\
            &\sigma  \equiv  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \, \nonumber
        \end{align}
        By Lemma \ref{lem:appendix:gen}(3), the judgement (\ref{equ:lam}) implies that there exists an expression $\tau'_{{\mathrm{2}}}$ such that
        \begin{align}
            &\Pi \, \ottmv{x}  \ottsym{:}  \tau'_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \equiv  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau'_{{\mathrm{2}}} \label{equ:lameq}\\
            &\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau'_{{\mathrm{2}}} \nonumber
        \end{align}
        Hence, by (\ref{equ:lameq}) we have $\tau_{{\mathrm{1}}}  \equiv  \tau'_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}  \equiv  \tau'_{{\mathrm{2}}}$. Then we can obtain $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{2}}}$ and $\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}$. By Lemma \ref{lem:appendix:subst}, we have $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,  \ottsym{:}  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$. Therefore, we conclude with $\sigma'  \equiv  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,  \equiv  \sigma$.
        
        \item[Case $\ottdruleSXXApp{}$:] $\quad$ \\
        Suppose $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \sigma$ and $\Gamma  \vdash  \ottnt{e'_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \sigma'$. By Lemma \ref{lem:appendix:gen}(2), there exist expressions $\tau_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}$ such that 
        \begin{align*}
            &\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)} \\
            &\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}\\
            &\sigma  \equiv  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,
        \end{align*}
        By induction hypothesis, we have $\Gamma  \vdash  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}$. By rule \ruleref{T\_App}, we obtain $\Gamma  \vdash  \ottnt{e'_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$. Therefore, $\sigma'  \equiv  \tau_{{\mathrm{2}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,  \equiv  \sigma$.
        
        \item[Case $\ottdruleSXXCastDown{}$:] $\quad$ \\
        Suppose $\Gamma  \vdash  \kw{cast}_{\downarrow} \, \ottnt{e}  \ottsym{:}  \sigma$ and $\Gamma  \vdash  \kw{cast}_{\downarrow} \, \ottnt{e'}  \ottsym{:}  \sigma'$. By Lemma \ref{lem:appendix:gen}(7), there exist expressions $\tau_{{\mathrm{1}}}, \tau_{{\mathrm{2}}}$ such that 
        \begin{align*}
            &\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{1}}} \qquad \Gamma  \vdash  \tau_{{\mathrm{2}}}  \ottsym{:}  \star \\
            &\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}} \qquad \sigma  \equiv  \tau_{{\mathrm{2}}}
        \end{align*}
        By induction hypothesis, we have $\Gamma  \vdash  \ottnt{e'}  \ottsym{:}  \tau_{{\mathrm{1}}}$. By rule \ruleref{T\_CastDown}, we obtain $\Gamma  \vdash  \kw{cast}_{\downarrow} \, \ottnt{e'}  \ottsym{:}  \tau_{{\mathrm{2}}}$. Therefore, $\sigma'  \equiv  \tau_{{\mathrm{2}}}  \equiv  \sigma$.
        
        \item[Case $\ottdruleSXXCastDownUp{}$:] $\quad$ \\
        Suppose $\Gamma  \vdash  \kw{cast}_{\downarrow} \, \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e}  \ottsym{)}  \ottsym{:}  \sigma$ and $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \sigma'$. By Lemma \ref{lem:appendix:gen}(7), there exist expressions $\tau'_{{\mathrm{1}}}, \tau_{{\mathrm{2}}}$ such that 
        \begin{align}
            &\Gamma  \vdash  \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e}  \ottsym{)}  \ottsym{:}  \tau'_{{\mathrm{1}}} \label{equ:fold} \\
            &\tau'_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}} \label{equ:foldeq1} \\
            &\sigma  \equiv  \tau_{{\mathrm{2}}} \label{equ:foldeq4}
        \end{align}
        By Lemma \ref{lem:appendix:gen}(6), the judgement (\ref{equ:fold}) implies that there exists an expression $\tau'_{{\mathrm{2}}}$ such that
        \begin{align}
            &\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau'_{{\mathrm{2}}} \label{equ:foldr} \\
            &\tau_{{\mathrm{1}}}  \longrightarrow  \tau'_{{\mathrm{2}}} \label{equ:foldeq2} \\
            &\tau'_{{\mathrm{1}}}  \equiv  \tau_{{\mathrm{1}}} \label{equ:foldeq3}
        \end{align}
        By (\ref{equ:foldeq1}, \ref{equ:foldeq2}, \ref{equ:foldeq3}) and Lemma \ref{lem:appendix:unired} we obtain $\tau_{{\mathrm{2}}}  \equiv  \tau'_{{\mathrm{2}}}$. From (\ref{equ:foldr}) we have $\sigma'  \equiv  \tau'_{{\mathrm{2}}}$. Therefore, by (\ref{equ:foldeq4}), $\sigma'  \equiv  \tau'_{{\mathrm{2}}}  \equiv  \tau_{{\mathrm{2}}}  \equiv  \sigma$.
        
        \item[Case $\ottdruleSXXMu{}$:] $\quad$ \\
        Suppose $\Gamma  \vdash  \ottsym{(}  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{)}  \ottsym{:}  \sigma$ and $\Gamma  \vdash  \ottnt{e}  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{]} \,  \ottsym{:}  \sigma'$. By Lemma \ref{lem:appendix:gen}(5), we have $\sigma  \equiv  \tau$ and $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau  \vdash  \ottnt{e}  \ottsym{:}  \tau$. Then we obtain $\Gamma  \vdash  \ottsym{(}  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{)}  \ottsym{:}  \tau$. Thus by Lemma \ref{lem:appendix:subst}, we have $\Gamma  \vdash  \ottnt{e}  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{]} \,  \ottsym{:}  \tau  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{]} \,$.
        
        Note that $\ottmv{x}:\tau$, i.e. the type of $\ottmv{x}$ is $\tau$, then $\ottmv{x} \notin \FV(\tau)$ holds implicitly. Hence, by the definition of substitution, we obtain $\tau  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{]} \,  \equiv  \tau$. Therefore, $\sigma'  \equiv  \tau  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{]} \,  \equiv  \tau  \equiv  \sigma$.
    \end{description}
\end{proof}

\begin{lem}[Progress]
If $\vdash  \ottnt{e}  \ottsym{:}  \sigma$ then either $\ottnt{e}$ is a value $v$ or there exists $\ottnt{e}'$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
\end{lem}

\begin{proof}
    By induction on the derivation of $\vdash  \ottnt{e}  \ottsym{:}  \sigma$ as follows:
    \begin{description}
        \item[Case $\ottnt{e}  \ottsym{=}  \ottmv{x}$:] Impossible, because the context is empty.
        \item[Case $\ottnt{e}  \ottsym{=}  \ottnt{v}$:] Trivial, since $\ottnt{e}$ is already a value that has one of the following forms:
		\begin{inparaenum}[(1)]
		    \item $\star$,
			\item $\lambda  \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}$,
			\item $\Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}$,
			\item $\kw{cast}^{\uparrow} \, \ottsym{[}  \tau  \ottsym{]} \,  \ottnt{e}$.
		\end{inparaenum}
		\item[Case $\ottnt{e}=\ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}$:] By Lemma \ref{lem:appendix:gen}(2), there exist expressions $\tau_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}$ such that $\vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}$ and $\vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}$. Consider whether $\ottnt{e_{{\mathrm{1}}}}$ is a value:
    		\begin{itemize}
    		    \item If $\ottnt{e_{{\mathrm{1}}}}=v$, by Lemma \ref{lem:appendix:gen}(3), it must be a $\lambda$-term such that $\ottnt{e_{{\mathrm{1}}}}  \equiv  \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e'_{{\mathrm{1}}}}$ for some $\ottnt{e'_{{\mathrm{1}}}}$ satisfying $\vdash  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{2}}}$. Then by rule \ruleref{S\_Beta}, we have $\ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{)} \, \ottnt{e_{{\mathrm{2}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$. Thus, there exists $\ottnt{e'}  \equiv  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
    		    \item Otherwise, by induction hypothesis, there exists $\ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. Then by rule \ruleref{S\_App}, we have $\ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}$. Thus, there exists $\ottnt{e'}  \equiv  \ottnt{e'_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
    		\end{itemize}
		\item[Case $\ottnt{e}=\kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}$:] By Lemma \ref{lem:appendix:gen}(7), there exist expressions $\tau_{{\mathrm{1}}}$ and $\tau_{{\mathrm{2}}}$ such that $\vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}$ and $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$. Consider whether $\ottnt{e_{{\mathrm{1}}}}$ is a value:
		     \begin{itemize}
    		    \item If $\ottnt{e_{{\mathrm{1}}}}=v$, by Lemma \ref{lem:appendix:gen}(6), it must be a $ \kw{cast}^{\uparrow} $-term such that $\ottnt{e_{{\mathrm{1}}}}  \equiv  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e'_{{\mathrm{1}}}}$ for some $\ottnt{e'_{{\mathrm{1}}}}$ satisfying $\vdash  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{2}}}$. Then by rule \ruleref{S\_CastDownUp}, we can obtain $\kw{cast}_{\downarrow} \, \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e'_{{\mathrm{1}}}}  \ottsym{)}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. Thus, there exists $\ottnt{e'}  \equiv  \ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
    		    \item Otherwise, by induction hypothesis, there exists $\ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. Then by rule \ruleref{S\_CastDown}, we have $\kw{cast}_{\downarrow} \, \ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \kw{cast}_{\downarrow} \, \ottnt{e'_{{\mathrm{1}}}}$. Thus, there exists $\ottnt{e'}  \equiv  \kw{cast}_{\downarrow} \, \ottnt{e'_{{\mathrm{1}}}}$ such that $\ottnt{e}  \longrightarrow  \ottnt{e'}$.
    		\end{itemize}
		\item[Case $\ottnt{e}=\mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}$:] By rule \ruleref{S\_Mu}, there always exists $\ottnt{e'}  \equiv  \ottnt{e_{{\mathrm{1}}}}  \ottsym{[}  \ottmv{x}  \mapsto  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e_{{\mathrm{1}}}}  \ottsym{]} \,$.
    \end{description}
\end{proof}

\section{Full Specification of Source Language}
\subsection{Syntax}
See Figure \ref{fig:appendix:syntax}.
\begin{figure*}
\centering
\gram{\ottpgm\ottinterrule
\ottdecl\ottinterrule
\ottu\ottinterrule
\ottp\ottinterrule
\ottE\ottinterrule
\ottV\ottinterrule
\ottGs}
    \[
    \begin{array}{lllll}
     &&&& \text{Syntactic Sugar} \\
     T_{{\mathrm{1}}}  \rightarrow  T_{{\mathrm{2}}} & \triangleq & \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}} & x \not \in \FV(T_{{\mathrm{2}}}) & \quad\text{Function type} \\
     \ottsym{(}  \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{)}  \rightarrow  T_{{\mathrm{2}}} & \triangleq & \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}} & x \in \FV(T_{{\mathrm{2}}}) & \quad\text{Dependent function type} \\
     \kw{data} \, \ottmv{R}  \,\overline{  \ottnt{u}  \ottsym{:}  \kappa  }\,  \ottsym{=}  \ottmv{K}  \ottsym{\{}  \,\overline{  \ottmv{N}  \ottsym{:}  T  }\,  \ottsym{\}} & \triangleq &
                    \kw{data} \, \ottmv{R}  \,\overline{  \ottnt{u}  \ottsym{:}  \kappa  }\,  \ottsym{=}  \ottmv{K}  \,\overline{  T  }\,; && \quad\text{Record} \\
                  &&  \kw{let} ~\ottmv{N}_i : \ottsym{(}  \,\overline{  \ottnt{u}  \ottsym{:}  \kappa  }\,  \ottsym{)}  \rightarrow  \ottmv{R}    \,\overline{  \ottnt{u}  }\,  \rightarrow  T_i = & \forall i &  \\
                  && \lambda  \,\overline{  \ottnt{u}  \ottsym{:}  \kappa  }\,  \ottsym{.}  \lambda  \ottmv{y}  \ottsym{:}  \ottmv{R} \, \,\overline{  \ottnt{u}  }\,  \ottsym{.}  \kw{case} \, \ottmv{y} \, \kw{of} \, \ottmv{K}  \,\overline{  \ottmv{x}  \ottsym{:}  T  }\,  \Rightarrow  \ottmv{x}_i~ \kw{in}  && \\
    \end{array}
    \]
\caption{Syntax of source language}
\label{fig:appendix:syntax}
\end{figure*}

\subsection{Operational Semantics}
\ottdefnstepsrc{}
\ottusedrule{\ottdruleSCXXCaseMatch{}}

\subsection{Expression Typing}
See Figure \ref{fig:appendix:typing}.
\begin{figure*}
\ottdefnctxsrc{}
\ottdefnpgmsrc{}
\ottdefndeclsrc{}
\ottdefnpatsrc{}
\ottdefnexprsrc{}
\caption{Typing rules of source language}
\label{fig:appendix:typing}
\end{figure*}

\subsection{Translation to the Core}
See Figure \ref{fig:appendix:translate}.
\begin{figure*}
\ottdefnctxtrans{}
\ottdefnpgmtrans{}
\ottdefndecltrans{}
\begin{align*}
\ottnt{e}  \triangleq ~  &  \kw{let} \, \ottmv{D}  \ottsym{:}  \ottsym{(}  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  }\,  \ottsym{)}  \rightarrow  \star  \ottsym{=}  \mu \, \ottmv{X}  \ottsym{:}  \ottsym{(}  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  }\,  \ottsym{)}  \rightarrow  \star  \ottsym{.}  \lambda  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottsym{(}  \alpha  \ottsym{:}  \star  \ottsym{)}  \rightarrow  \,\overline{  \ottsym{(}  \,\overline{  \tau  }\,  \ottsym{[}  \ottmv{D}  \mapsto  \ottmv{X}  \ottsym{]} \,  \rightarrow  \alpha  \ottsym{)}  }\,  \rightarrow  \alpha \, \kw{in} \, \\ &  \kw{let} \, \ottmv{K_{\ottmv{i}}}  \ottsym{:}  \ottsym{(}  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  }\,  \ottsym{)}  \rightarrow  \,\overline{  \tau  }\,  \rightarrow  \ottmv{D}    \,\overline{  \ottnt{u}  }\,  \ottsym{=}  \lambda  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \tau  }\,  \ottsym{.}  \kw{cast}_{\uparrow}^n \, \ottsym{[}  \ottmv{D}    \,\overline{  \ottnt{u}  }\,  \ottsym{]} \,  \ottsym{(}  \lambda  \alpha  \ottsym{:}  \star  \ottsym{.}  \lambda  \,\overline{  b  \ottsym{:}  \,\overline{  \tau  }\,  \rightarrow  \alpha  }\,  \ottsym{.}  b_{\ottmv{i}} \, \,\overline{  \ottmv{x}  }\,  \ottsym{)} \, \kw{in} \, 
\end{align*}
\ottdefnpattrans{}
\ottdefnexprtrans{}
\caption{Translation rules of source language}
\label{fig:appendix:translate}
\end{figure*}


\section{Proofs about Source Language}
\subsection{Type-safety of Translation}
\begin{lem}[Type-safety of reduction translation]\label{lem:appendix:src:redtr}
If $\ottnt{E_{{\mathrm{1}}}}  \longrightarrow  \ottnt{E_{{\mathrm{2}}}}$ and $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{1}}}}  :  T_{{\mathrm{1}}}   \rightsquigarrow   \ottnt{e_{{\mathrm{1}}}} $, $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{2}}}}  :  T_{{\mathrm{2}}}   \rightsquigarrow   \ottnt{e_{{\mathrm{2}}}} $ for some context $\Sigma$, then $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e_{{\mathrm{2}}}}$.
\end{lem}

\begin{proof}
    By induction on the relation $\ottnt{E_{{\mathrm{1}}}}  \longrightarrow  \ottnt{E_{{\mathrm{2}}}}$. Most cases are the same as core language, which are trivial. We only treat interesting cases \ruleref{SC\_Case} and \ruleref{SC\_CaseMatch}.
    \begin{description}
        \item[Case \scriptsize{$\ottdruleSCXXCase{}$}:] $\quad$ \\
        By induction hypothesis, we have $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{1}}}}  :  T   \rightsquigarrow   \ottnt{e_{{\mathrm{1}}}} $, $ \Sigma  \labeledjudge{s}  \ottnt{E'_{{\mathrm{1}}}}  :  T'   \rightsquigarrow   \ottnt{e'_{{\mathrm{1}}}} $ and $\ottnt{e_{{\mathrm{1}}}}  \longrightarrow  \ottnt{e'_{{\mathrm{1}}}}$. Note that $ \Sigma  \labeledjudge{s}  \kw{case} \, \ottnt{E_{{\mathrm{1}}}} \, \kw{of} \, \,\overline{  \ottnt{p}  \Rightarrow  \ottnt{E}  }\,  :  T   \rightsquigarrow   \ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottnt{e_{{\mathrm{1}}}}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e}  }\, $ and $ \Sigma  \labeledjudge{s}  \kw{case} \, \ottnt{E'_{{\mathrm{1}}}} \, \kw{of} \, \,\overline{  \ottnt{p}  \Rightarrow  \ottnt{E}  }\,  :  T   \rightsquigarrow   \ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottnt{e'_{{\mathrm{1}}}}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e}  }\, $. And by \ruleref{S\_CastDown}, we have the result $\ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottnt{e_{{\mathrm{1}}}}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e}  }\,  \longrightarrow  \ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottnt{e'_{{\mathrm{1}}}}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e}  }\,$.
        \item[Case \scriptsize{$\ottdruleSCXXCaseMatch{}$}:] $\quad$ \\
        By rule \ruleref{TRdecl\_data}, $\ottmv{K_{\ottmv{i}}}  \equiv  \lambda  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \kw{cast}_{\uparrow}^n \, \ottsym{[}  \ottmv{D}    \,\overline{  \ottnt{u}  }\,  \ottsym{]} \,  \ottsym{(}  \lambda  \alpha  \ottsym{:}  \star  \ottsym{.}  \lambda  \,\overline{  b  \ottsym{:}  \,\overline{  \sigma  }\,  \rightarrow  \alpha  }\,  \ottsym{.}  b_{\ottmv{i}} \, \,\overline{  \ottmv{x}  }\,  \ottsym{)}$. By \ruleref{TRpat\_Alt} and \ruleref{TR\_Case}, we have $ \Sigma  \labeledjudge{s}  \kw{case} \, \ottmv{K_{\ottmv{i}}} \, \,\overline{  \ottnt{u}  }\, \, \,\overline{  \ottnt{E_{{\mathrm{1}}}}  }\, \, \kw{of} \, \,\overline{  \ottnt{p}  \Rightarrow  \ottnt{E}  }\,  :  T   \rightsquigarrow   \ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottsym{(}  \ottmv{K_{\ottmv{i}}}  \,\overline{  \ottnt{u}  }\,  \,\overline{  \ottnt{e_{{\mathrm{1}}}}  }\,  \ottsym{)}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e'}  }\, $ where
        \begin{align*}
                & \,\overline{   \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{1}}}}  :  T_{{\mathrm{1}}}   \rightsquigarrow   \ottnt{e_{{\mathrm{1}}}}   }\, \\
                & \,\overline{   \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  :  \star   \rightsquigarrow   \sigma   }\, \\
                & \,\overline{   \Sigma  \labeledjudge{s}  \ottnt{E}  :  T   \rightsquigarrow   \ottnt{e}   }\, \\
                & \,\overline{  \ottnt{e'}  \equiv  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottnt{e}  }\,.
        \end{align*}
        Thus, we have the following reduction sequence:
        \begin{align*}
            &\kw{cast}_{\downarrow}^n \, \ottsym{(}  \kw{cast}_{\uparrow}^n \, \ottsym{[}  \ottmv{D}    \,\overline{  \ottnt{u}  }\,  \ottsym{]} \,  \ottsym{(}  \lambda  \alpha  \ottsym{:}  \star  \ottsym{.}  \lambda  \,\overline{  b  \ottsym{:}  \,\overline{  \sigma  }\,  \rightarrow  \alpha  }\,  \ottsym{.}  b_{\ottmv{i}} \, \,\overline{  \ottnt{e_{{\mathrm{1}}}}  }\,  \ottsym{)}  \ottsym{)} \, \tau \, \,\overline{  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottnt{e}  }\, \\
            & \longrightarrow_n   \ottsym{(}  \lambda  \alpha  \ottsym{:}  \star  \ottsym{.}  \lambda  \,\overline{  b  \ottsym{:}  \,\overline{  \sigma  }\,  \rightarrow  \alpha  }\,  \ottsym{.}  b_{\ottmv{i}} \, \,\overline{  \ottnt{e_{{\mathrm{1}}}}  }\,  \ottsym{)} \, \tau \, \,\overline{  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottnt{e}  }\, \\
            & \longrightarrow   \ottsym{(}  \lambda  \,\overline{  b  \ottsym{:}  \,\overline{  \sigma  }\,  \rightarrow  \tau  }\,  \ottsym{.}  b_{\ottmv{i}} \, \,\overline{  \ottnt{e_{{\mathrm{1}}}}  }\,  \ottsym{)} \, \,\overline{  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottnt{e}  }\, \\
            & \longrightarrow   \ottsym{(}  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottnt{e_{\ottmv{i}}}  \ottsym{)} \, \,\overline{  \ottnt{e_{{\mathrm{1}}}}  }\, \\
            & \longrightarrow   \ottnt{e_{\ottmv{i}}}  \ottsym{[}  \,\overline{  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{1}}}}  }\,  \ottsym{]} \,.
        \end{align*}
        Note that $ \Sigma  \labeledjudge{s}  \ottnt{E_{\ottmv{i}}}  \ottsym{[}  \,\overline{  \ottmv{x_{\ottmv{i}}}  \mapsto  \ottnt{E_{{\mathrm{1}}}}  }\,  \ottsym{]} \,  :  T   \rightsquigarrow   \ottnt{e_{\ottmv{i}}}  \ottsym{[}  \,\overline{  \ottmv{x_{\ottmv{i}}}  \mapsto  \ottnt{e_{{\mathrm{1}}}}  }\,  \ottsym{]} \, $, therefore the reduction sequence above follows the result.
    \end{description}
\end{proof}

\begin{lem}[Type-safety of expression translation]
If $ \Sigma  \labeledjudge{s}  \ottnt{E}  :  T   \rightsquigarrow   \ottnt{e} $, $ \Sigma  \labeledjudge{s}  T  :  \star   \rightsquigarrow   \tau $ and $ \labeledjudge{wf}  \Sigma   \rightsquigarrow   \Gamma $, then $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau$.
\end{lem}

\begin{proof}
    By induction on the derivation of $ \Sigma  \labeledjudge{s}  \ottnt{E}  :  T   \rightsquigarrow   \ottnt{e} $ . Suppose there is a core language context $\Gamma$ such that $ \labeledjudge{wf}  \Sigma   \rightsquigarrow   \Gamma $.
    \begin{description}
        \item[Case \ruleref{TR\_Ax}:] Trivial. $\ottnt{e} = \tau = \star$ and $ \Sigma  \labeledjudge{s}  \star  :  \star $ holds by rule \ruleref{T\_Ax}.
        \item[Case \ruleref{TR\_Var}:] Trivial. By rule \ruleref{T\_Var}, we have $ \labeledjudge{wf}  \Sigma   \rightsquigarrow   \Gamma $, then $\ottmv{x}:\tau  \in  \Gamma$ where $ \Sigma  \labeledjudge{s}  T  :  \star   \rightsquigarrow   \tau $.
        \item[Case \ruleref{TR\_App}:] Suppose $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{1}}}} \, \ottnt{E_{{\mathrm{2}}}}  :  T_{{\mathrm{1}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{E_{{\mathrm{2}}}}  \ottsym{]} \,   \rightsquigarrow   \ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}} $ and $ \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{E_{{\mathrm{2}}}}  \ottsym{]} \,  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \, $. By induction hypothesis, we have $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{2}}}  \ottsym{.}  \tau_{{\mathrm{1}}}  \ottsym{)}$ where $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{1}}}}  :  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{2}}}  \ottsym{.}  T_{{\mathrm{1}}}  \ottsym{)}   \rightsquigarrow   \ottnt{e_{{\mathrm{1}}}} $, $ \Sigma  \labeledjudge{s}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{2}}}  \ottsym{.}  T_{{\mathrm{1}}}  \ottsym{)}  :  \star   \rightsquigarrow   \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{2}}}  \ottsym{.}  \tau_{{\mathrm{1}}}  \ottsym{)} $. And $\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{2}}}$ where $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{2}}}}  :  T_{{\mathrm{2}}}   \rightsquigarrow   \ottnt{e_{{\mathrm{2}}}} $, $ \Sigma  \labeledjudge{s}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{2}}} $. Thus by rule \ruleref{T\_App}, we have $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}} \, \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{[}  \ottmv{x}  \mapsto  \ottnt{e_{{\mathrm{2}}}}  \ottsym{]} \,$.
        \item[Case \ruleref{TR\_Lam}:] Suppose $ \Sigma  \labeledjudge{s}  \ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  \ottnt{E}  \ottsym{)}  :  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}}  \ottsym{)}   \rightsquigarrow   \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e} $ and $ \Sigma  \labeledjudge{s}  \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}} $. By induction hypothesis, we have $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{2}}}$ where $ \Sigma  \ottsym{,}  \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \labeledjudge{s}  \ottnt{E}  :  T_{{\mathrm{2}}}   \rightsquigarrow   \ottnt{e} $, $ \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}} $, $ \Sigma  \labeledjudge{s}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{2}}} $. And $\Gamma  \vdash  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{:}  \star$ where $ \Sigma  \labeledjudge{s}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}}  \ottsym{)}  :  \star   \rightsquigarrow   \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}} $. Thus by rule \ruleref{T\_Lam}, we have $\Gamma  \vdash  \ottsym{(}  \lambda  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \ottnt{e}  \ottsym{)}  \ottsym{:}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}$.
        \item[Case \ruleref{TR\_Pi}:] Suppose $ \Sigma  \labeledjudge{s}  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \ottsym{.}  T_{{\mathrm{2}}}  \ottsym{)}  :  \star   \rightsquigarrow   \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}} $. By induction hypothesis, we have $\Gamma  \vdash  \tau_{{\mathrm{1}}}  \ottsym{:}  \star$ where $ \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}} $. And $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \vdash  \tau_{{\mathrm{2}}}  \ottsym{:}  \star$ where $ \Sigma  \ottsym{,}  \ottmv{x}  \ottsym{:}  T_{{\mathrm{1}}}  \labeledjudge{s}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{2}}} $. Thus by rule \ruleref{T\_Pi} $\Gamma  \vdash  \ottsym{(}  \Pi \, \ottmv{x}  \ottsym{:}  \tau_{{\mathrm{1}}}  \ottsym{.}  \tau_{{\mathrm{2}}}  \ottsym{)}  \ottsym{:}  \star$.
        \item[Case \ruleref{TR\_CastUp}:] Suppose $ \Sigma  \labeledjudge{s}  \ottsym{(}  \kw{cast}^{\uparrow} \, \ottsym{[}  T_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{E}  \ottsym{)}  :  T_{{\mathrm{1}}}   \rightsquigarrow   \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e} $ and $ \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}} $. By induction hypothesis, we have $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{2}}}$ where $ \Sigma  \labeledjudge{s}  \ottnt{E}  :  T_{{\mathrm{2}}}   \rightsquigarrow   \ottnt{e} $, $ \Sigma  \labeledjudge{s}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{2}}} $. We also have $ \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}} $ and $T_{{\mathrm{1}}}  \longrightarrow  T_{{\mathrm{2}}}$. By Lemma \ref{lem:appendix:src:redtr}, we obtain $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$. Thus, by rule \ruleref{T\_CastUp}, we have $\Gamma  \vdash  \kw{cast}^{\uparrow} \, \ottsym{[}  \tau_{{\mathrm{1}}}  \ottsym{]} \,  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{1}}}$.
        \item[Case \ruleref{TR\_CastDown}:] Suppose $ \Sigma  \labeledjudge{s}  \ottsym{(}  \kw{cast}_{\downarrow} \, \ottnt{E}  \ottsym{)}  :  T_{{\mathrm{2}}}   \rightsquigarrow   \kw{cast}_{\downarrow} \, \ottnt{e} $ and $ \Sigma  \labeledjudge{s}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{2}}} $. By induction hypothesis, we have $\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{1}}}$ where $ \Sigma  \labeledjudge{s}  \ottnt{E}  :  T_{{\mathrm{1}}}   \rightsquigarrow   \ottnt{e} $, $ \Sigma  \labeledjudge{s}  T_{{\mathrm{1}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}} $. We also have $T_{{\mathrm{1}}}  \longrightarrow  T_{{\mathrm{2}}}$ and $ \Sigma  \labeledjudge{s}  T_{{\mathrm{2}}}  :  \star   \rightsquigarrow   \tau_{{\mathrm{2}}} $. By Lemma \ref{lem:appendix:src:redtr}, we obtain $\tau_{{\mathrm{1}}}  \longrightarrow  \tau_{{\mathrm{2}}}$. Thus, by rule \ruleref{T\_CastDown}, we have $\Gamma  \vdash  \kw{cast}_{\downarrow} \, \ottnt{e}  \ottsym{:}  \tau_{{\mathrm{2}}}$.
        \item[Case \ruleref{TR\_Mu}:] Suppose $ \Sigma  \labeledjudge{s}  \ottsym{(}  \mu \, \ottmv{x}  \ottsym{:}  T  \ottsym{.}  \ottnt{E}  \ottsym{)}  :  T   \rightsquigarrow   \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e} $ and $ \Sigma  \labeledjudge{s}  T  :  \star   \rightsquigarrow   \tau $. By induction hypothesis, we have $\Gamma  \ottsym{,}  \ottmv{x}  \ottsym{:}  \tau  \vdash  \ottnt{e}  \ottsym{:}  \tau$ where $ \Sigma  \ottsym{,}  \ottmv{x}  \ottsym{:}  T  \labeledjudge{s}  \ottnt{E}  :  T   \rightsquigarrow   \ottnt{e} $. Thus by rule \ruleref{T\_Mu}, we have $\Gamma  \vdash  \ottsym{(}  \mu \, \ottmv{x}  \ottsym{:}  \tau  \ottsym{.}  \ottnt{e}  \ottsym{)}  \ottsym{:}  \tau$.
        \item[Case \ruleref{TR\_Case}:] Suppose $ \Sigma  \labeledjudge{s}  \kw{case} \, \ottnt{E_{{\mathrm{1}}}} \, \kw{of} \, \,\overline{  \ottnt{p}  \Rightarrow  \ottnt{E_{{\mathrm{2}}}}  }\,  :  T   \rightsquigarrow   \ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottnt{e_{{\mathrm{1}}}}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e_{{\mathrm{2}}}}  }\, $ and $ \Sigma  \labeledjudge{s}  T  :  \star   \rightsquigarrow   \tau $. By induction hypothesis, we have $ \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{1}}}}  :  S   \rightsquigarrow   \ottnt{e_{{\mathrm{1}}}} $ and $\,\overline{   \Sigma  \labeledjudge{p}  \ottnt{p}   \Rightarrow   \ottnt{E_{{\mathrm{2}}}}  :  S   \rightarrow   T   \rightsquigarrow   \ottnt{e_{{\mathrm{2}}}}   }\,$. And $\Gamma  \vdash  \ottnt{e_{{\mathrm{1}}}}  \ottsym{:}  \tau_{{\mathrm{1}}}$ where $ \Sigma  \labeledjudge{s}  S  :  \star   \rightsquigarrow   \tau_{{\mathrm{1}}} $. By rule \ruleref{TRpat\_Alt}, we have
        \begin{align*}
            \ottnt{p} & \equiv  \ottmv{K}  \,\overline{  \ottmv{x}  \ottsym{:}  S_{{\mathrm{1}}}  \ottsym{[}  \,\overline{  \ottnt{u}  \mapsto  \upsilon  }\,  \ottsym{]} \,  }\, \\
            S & \equiv  \ottmv{D}    \,\overline{  \upsilon  }\, \\
            \ottnt{e_{{\mathrm{2}}}} & \equiv  \lambda  \,\overline{  \ottmv{x}  \ottsym{:}  \sigma  }\,  \ottsym{.}  \ottnt{e}
        \end{align*}
        where
        \begin{align*}
            & \Sigma  \labeledjudge{s}  \ottnt{E_{{\mathrm{2}}}}  :  T   \rightsquigarrow   \ottnt{e}  \\
            &\Gamma  \vdash  \ottnt{e}  \ottsym{:}  \tau \\
            & \Sigma  \labeledjudge{s}  S_{{\mathrm{1}}}  \ottsym{[}  \,\overline{  \ottnt{u}  \mapsto  \upsilon  }\,  \ottsym{]} \,  :  \star   \rightsquigarrow   \sigma 
        \end{align*}
        By rule \ruleref{TRdecl\_Data}, we have $\ottmv{D}  \equiv  \mu \, \ottmv{X}  \ottsym{:}  \ottsym{(}  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  ^{*}  }\,  \ottsym{)}  \rightarrow  \star  \ottsym{.}  \lambda  \,\overline{  \ottnt{u}  \ottsym{:}  \sigma  ^{*}  }\,  \ottsym{.}  \ottsym{(}  \alpha  \ottsym{:}  \star  \ottsym{)}  \rightarrow  \,\overline{  \ottsym{(}  \,\overline{  \sigma  }\,  \ottsym{[}  \ottmv{D}  \mapsto  \ottmv{X}  \ottsym{]} \,  \rightarrow  \alpha  \ottsym{)}  }\,  \rightarrow  \alpha$. Thus, $\tau_{{\mathrm{1}}}  \equiv  \ottmv{D}  ^{*} \,\overline{  \sigma  ^{*}  }\,$ where $\,\overline{   \Sigma  \labeledjudge{s}  \upsilon  :  \star   \rightsquigarrow   \sigma  ^{*}   }\,$. Then by rule \ruleref{T\_CastDown} and the definition of $n$-step cast operator, the type of $\kw{cast}_{\downarrow}^n \, \ottnt{e_{{\mathrm{1}}}}$ is $\ottsym{(}  \alpha  \ottsym{:}  \star  \ottsym{)}  \rightarrow  \,\overline{  \ottsym{(}  \,\overline{  \sigma  }\,  \rightarrow  \alpha  \ottsym{)}  }\,  \rightarrow  \alpha$. Note that by rule \ruleref{T\_Lam}, $\Gamma  \vdash  \ottnt{e_{{\mathrm{2}}}}  \ottsym{:}  \,\overline{  \sigma  }\,  \rightarrow  \tau$. Therefore, by rule \ruleref{T\_App}, we obtain $\Gamma  \vdash  \ottsym{(}  \kw{cast}_{\downarrow}^n \, \ottnt{e_{{\mathrm{1}}}}  \ottsym{)} \, \tau \, \,\overline{  \ottnt{e_{{\mathrm{2}}}}  }\,  \ottsym{:}  \tau$, which follows the result.
    \end{description}
\end{proof}


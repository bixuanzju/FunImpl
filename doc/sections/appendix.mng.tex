\section{Specification of core language}

\subsection{Syntax}
\gram{\otte\ottinterrule
        \otts\ottinterrule
        \ottG\ottinterrule
        \ottv}

\subsection{Operational semantics and expression typing}
\ottdefnstep{}
\ottusedrule{\ottdruleSXXMu{}}
\ottdefnexpr{}
\ottusedrule{\ottdruleTXXMu{}}

\section{Proofs about core language}
\subsection{Properties}
\newcommand{\FV}{\mathsf{FV}}
\newcommand{\dom}{\mathsf{dom}}
\begin{lem}[Free variable lemma]\label{lem:free}
    If $[[G |- e:t]]$, then $\FV(e) \subseteq \dom([[G]])$ and $\FV([[t]]) \subseteq \dom([[G]])$.
\end{lem}

\begin{proof}
    By induction on the derivation of $[[G |- e:t]]$. We only treat cases \ruleref{T\_Mu}, \ruleref{T\_CastUp} and \ruleref{T\_CastDown} (since proofs of other cases are the same as \cc \cite{handbook}):
    \begin{description}
        \item[Case \ruleref{T\_Mu}:] From premises of $[[G |- (mu x:t.e1) : t]]$, by induction hypothesis, we have $\FV(e_1) \subseteq \dom([[G]]) \cup \{x\}$ and $\FV(\tau) \subseteq \dom([[G]])$. Thus the result follows by $\FV([[mu x:t.e1]])=\FV(e_1) \setminus \{x\} \subseteq \dom([[G]])$ and $\FV(\tau) \subseteq \dom([[G]])$.
        \item[Case \ruleref{T\_CastUp}:] Since $\FV([[castup [t] e1]])=\FV([[e1]])$, the result follows directly by the induction hypothesis.
        \item[Case \ruleref{T\_CastDown}:] Since $\FV([[castdown e1]])=\FV([[e1]])$, the result follows directly by the induction hypothesis.
    \end{description}
\end{proof}

\begin{lem}[Substitution lemma]\label{lem:subst}
	If $[[G1, x:T, G2 |- e1:t]]$ and $[[G1 |- e2:T]]$, then $[[G1, G2 [x |-> e2] |- e1[x |-> e2]  : t[x |-> e2] ]]$.
\end{lem}

\begin{proof}
    By induction on the derivation of $[[G1, x:T, G2 |- e1:t]]$. Let $[[e* == e [x |-> e2] ]]$. Then the result can be written as $[[G1, G2* |- e1*  : t* ]]$. We only treat cases \ruleref{T\_Mu}, \ruleref{T\_CastUp} and \ruleref{T\_CastDown}. Consider the last step of derivation of the following cases:
    \begin{description}
        \item[Case \ruleref{T\_Mu}:] $\inferrule{[[G1, x:T, G2 |- e1:t]] \\ [[G1, x:T, G2 |- t:s]]}{[[G1, x:T, G2 |- (mu y:t.e1): t]]}$ 
        
        By induction hypothesis, we have $[[G1, G2* |- e1* : t*]]$ and $[[G1, G2* |- t* : s*]]$. Then by the deviation rule, $[[G1, G2* |- (mu y:t*.e1*):t*]]$. Thus we have $[[G1, G2* |- (mu y:t.e1)*:t*]]$ which is just the result.
        \item[Case \ruleref{T\_CastUp}:] $\inferrule{[[G1, x:T, G2 |- e1:t2]] \\ [[G1, x:T, G2 |- t1:s]] \\ [[t1 --> t2]]}{[[G1, x:T, G2 |- (castup [t1] e1):t1]]}$ 
        
        By induction hypothesis, we have $[[G1, G2* |- e1*:t2*]]$, $[[G1, G2* |- t1*:s*]]$ and $[[t1 --> t2]]$. By the definition of substitution, we can obtain $[[t1* --> t2*]]$ by $[[t1 --> t2]]$. Then by the deviation rule, $[[G1, G2* |- (castup [t1*] e1*):t1*]]$. Thus we have $[[G1, G2* |- (castup [t1] e1)*:t1*]]$ which is just the result.
        \item[Case \ruleref{T\_CastDown}:] $\inferrule{[[G1, x:T, G2 |- e1:t1]] \\ [[G1, x:T, G2 |- t2:s]] \\ [[t1 --> t2]]}{[[G1, x:T, G2 |- (castdown e1):t2]]}$ 
        
        By induction hypothesis, we have $[[G1, G2* |- e1*:t1*]]$, $[[G1, G2* |- t2*:s*]]$ and $[[t1 --> t2]]$ thus $[[t1* --> t2*]]$. Then by the deviation rule, $[[G1, G2* |- (castdown e1*):t2*]]$. Thus we have $[[G1, G2* |- (castdown e1)*:t2*]]$ which is just the result.
    \end{description}
\end{proof}

\begin{lem}[Generation lemma]\label{lem:gen}
$\quad$
\begin{enumerate}[(1)]
	\item If $[[G |- x:T]]$, then there exist an expression $[[t]]$ and a sort $s$ such that $[[t =a T]]$, $[[G |- t:s]]$ and $[[x:t elt G]]$.
	\item If $[[G |- e1 e2:T]]$, then there exist expressions $[[t1]]$ and $[[t2]]$ such that $[[G |- e1 : (Pi x:t1.t2)]]$, $[[G |- e2:t1]]$ and $[[T =a t2[x |-> e2] ]]$.
	\item If $[[G |- (\x:t1.e):T]]$, then there exist a sort $s$ and an expression $[[t2]]$ such that $[[T =a Pi x:t1.t2]]$ where $[[G |- (Pi x:t1.t2):s]]$ and $[[G,x:t1 |- e:t2]]$.
	\item If $[[G |- (Pi x:t1.t2):T]]$, then there exist sorts $[[s1]]$ and $[[s2]]$ such that $[[T == s2]]$, $[[G |- t1:s1]]$ and $[[G, x:t1 |- t2:s2]]$.
	\item If $[[G |- (mu x:t.e):T]]$, then there exists a sort $[[s]]$ such that $[[G |- t:s]]$, $[[T =a t]]$ and $[[G, x:t|-e:t]]$.
	\item If $[[G |- (castup [t1] e):T]]$, then there exist an expression $[[t2]]$ and a sort $s$ such that $[[G |- e:t2]]$, $[[G |- t1:s]]$, $[[t1 --> t2]]$ and $[[T =a t1]]$.
	\item If $[[G |- (castdown e):T]]$, then there exist expressions $[[t1]],[[t2]]$ and a sort $s$ such that $[[G |- e:t1]]$, $[[G |- t2:s]]$, $[[t1 --> t2]]$ and $[[T =a t2]]$.
\end{enumerate}
\end{lem}

\begin{proof}
    Consider a derivation of $[[G |- e:T]]$ for one of cases in the lemma. Note that rule \ruleref{T\_Weak} does not change $e$, then we can follow the process of derivation until expression $e$ is introduced the first time. The last step of derivation can be done by
    \begin{itemize}
        \item rule \ruleref{T\_Var} for case 1;
        \item rule \ruleref{T\_App} for case 2;
        \item rule \ruleref{T\_Lam} for case 3;
        \item rule \ruleref{T\_Pi} for case 4;
        \item rule \ruleref{T\_Mu} for case 5;
        \item rule \ruleref{T\_CastUp} for case 6;
        \item rule \ruleref{T\_CastDown} for case 7.
    \end{itemize}
    In each case, assume the conclusion of the rule is $[[G' |- e : t']]$ where $[[G']] \subseteq [[G]]$ and $[[t' =a T]]$. Then by inspection of used derivation rules, it can be shown that the statement of the lemma holds and is the only possible case.
\end{proof}

\begin{lem}[Correctness of types]\label{lem:corrtyp}
    If $[[G |- e:t]]$ then there exists a sort $s$ such that $[[t == s]]$ or $[[G |- t : s]]$.
\end{lem}

\begin{proof}
    Trivial induction on the derivation of $[[G |- e:t]]$ using Lemma \ref{lem:gen}.
\end{proof}

\begin{dfn}[Well-formed context]
	A \textbf{well-formed} context $[[G]]$ is defined by the following rules:
	
	\textnormal{\ottdefnctx{}}
\end{dfn}

\begin{lem}[Consistency of well-formed context]\label{lem:wfc}
	Given a well-formed initial context $[[G]]$, it remains well-formed through type checking.
\end{lem}

\begin{proof}
	Suppose $[[G]]$ is the initial context which is well-formed. To safely extend $[[G]]$ with a variable $x:[[t]]$, one should have $[[G |- t:s]]$ due to rule \ruleref{Env\_Var}. Note that when applying typing rules of $[[G |- e:t]]$, rule \ruleref{T\_Pi}, \ruleref{T\_Mu} and \ruleref{T\_Lam} will extend the context. We show that these rules cover the condition $[[G |- t:s]]$ with respect to $x:[[t]]$ as follows:
	\begin{description}
		\item[Case \ruleref{T\_Pi}:] To extend $[[G]]$ with $x:[[t1]]$, $[[G |- t1:s]]$ is already the premise of the rule.
		\item[Case \ruleref{T\_Mu}:] To extend $[[G]]$ with $x:[[t]]$, $[[G |- t:s]]$ is already the premise of the rule.
		\item[Case \ruleref{T\_Lam}:] To extend $[[G]]$ with $x:[[t1]]$, note that the premise $[[G |- (Pi x:t1.t2):s]]$ can be derived from rule \ruleref{T\_Pi}, which has the premise $[[G |- t1:s]]$.
	\end{description}
\end{proof}

\begin{lem}[Valid context optimization]\label{lem:wfcopt}
	With a well-formed initial context $[[G]]$, the \ruleref{T\_Var} and \ruleref{T\_Weak} can be replaced by the following rule: \ottusedrule{\ottdruleTSXXVar{}}
\end{lem}

\begin{proof}
	By Lemma \ref{lem:wfc}, the context $[[G]]$ remains well-formed if it is initially well-formed. Thus, the well-formedness of $[[G]]$ keeps without checking by rule \ruleref{T\_Var} and \ruleref{T\_Weak}. By Lemma \ref{lem:gen}, if $[[G |- x:t]]$, then $[[x:t elt G]]$. Thus, in order to check the type of a variable $x$, it is sufficient to check its bound type $[[t]]$ in the context, which is simply rule \ruleref{TS\_Var}.
\end{proof}

\subsection{Decidability of type checking}
\begin{lem}[Uniqueness of one-step reduction]\label{lem:unired}
	The relation $[[-->]]$, i.e. one-step reduction, is \textbf{unique} in the sense that given $e$ there is at most one $e'$ such that $[[e --> e']]$.
\end{lem}

\begin{proof}
	By induction on the structure of $e$:
	\begin{description}
	    \item[Case $e=s$, or $e=x$]: No such $e'$ exists since it is impossible to reduce a sort or a variable.
		\item[Case $e=v$:] $e$ has one of the following forms:
		\begin{inparaenum}[(1)]
			\item $[[\x:t.e]]$,
			\item $[[Pi x:t1.t2]]$,
			\item $[[castup [t] e]]$,
		\end{inparaenum}
		which cannot match any rules of $[[-->]]$. Thus there is no $e'$ such that $[[e-->e']]$.
		\item[Case $e=[[(\x:t.e1) e2]]$:] There is a unique $e'=[[ e1[x|->e2] ]]$ by rule \ruleref{S\_Beta}.
		\item[Case $e=[[castdown (castup [t] e)]]$:] There is a unique $e'=e$ by rule \ruleref{S\_CastDownUp}.
		\item[Case $e=[[mu x:t.e]]$:] There is a unique $e'=[[e[x|->mu x:t.e] ]]$ by rule \ruleref{S\_Mu}.
		\item[Case $e=[[e1 e2]]$ and $[[e1]]$ is not a $\lambda$-term:] If $[[e1]]=v$, there is no $[[e1']]$ such that $[[e1 --> e1']]$. Since $[[e1]]$ is not a $\lambda$-term, there is no rule to reduce $e$. Thus there is no $e'$ such that $[[e-->e']]$.
		
		Otherwise, there exists some $[[e1']]$ such that $[[e1 --> e1']]$. By the induction hypothesis, $[[e1']]$ is unique reduction of $[[e1]]$. Thus by rule \ruleref{S\_App}, $e'=[[e1' e2]]$ is the unique reduction for $e$.
		\item[Case $e=[[castdown e1]]$ and $[[e1]]$ is not a $[[castup]]$-term:] If $[[e1]]=v$, there is no $[[e1']]$ such that $[[e1 --> e1']]$. Since $[[e1]]$ is not a $[[castup]]$-term, there is no rule to reduce $e$. Thus there is no $e'$ such that $[[e-->e']]$.
		
		Otherwise, there exists some $[[e1']]$ such that $[[e1 --> e1']]$. By the induction hypothesis, $[[e1']]$ is unique reduction of $[[e1]]$. Thus by rule \ruleref{S\_CastDown}, $e'=[[castdown e1']]$ is the unique reduction for $e$.
	\end{description}
\end{proof}

\begin{lem}[Decidability of type checking]
	There is a decidable algorithm which given $[[G]], [[e]]$ computes the unique $[[t]]$ such that $[[G |- e:t]]$ or reports there is no such $[[t]]$.
\end{lem}

\begin{proof}
	By induction on the structure of $e$:
	\begin{description}
	    \item[Case $e=[[square]]$:] Impossible case and report error.
	    \item[Case $e=[[star]]$:] Trivial by applying \ruleref{T\_Ax} and $[[t == square]]$.
		\item[Case $e=x$:] By Lemma \ref{lem:wfcopt}, we only need to consider context $[[G]]$ that is well-formed. By rule \ruleref{TS\_Var}, if $[[x:t elt G]]$, $[[t]]$ is the unique type of $x$.
		\item[Case $e=[[e1 e2]]$, or $[[\x:t1.e1]]$, or $[[Pi x:t1.t2]]$, or $[[mu x:t.e1]]$:] Trivial according to Lemma \ref{lem:gen} by using rule \ruleref{T\_App}, \ruleref{T\_Lam}, \ruleref{T\_Pi}, or \ruleref{T\_Mu} respectively.
		\item[Case $e=[[castup [t1] e1]]$:] From the premises of rule \ruleref{T\_CastUp}, by induction hypothesis, we can derive the type of $[[e1]]$ as $[[t2]]$, and check whether $[[t1]]$ is legal, i.e. its sorts is either $[[star]]$ or $[[square]]$. If $[[t1]]$ is legal, by Lemma \ref{lem:unired}, there is at most one $[[t1']]$ such that $[[t1 --> t1']]$. If such $[[t1']]$ does not exist, then we report the type checking is failed. Otherwise, we examine if $[[t1']]$ is syntactically equal to $[[t2]]$, i.e. $[[t1' =a t2]]$. If the equality holds, we obtain the unique type of $[[e]]$ which is $[[t1]]$. Otherwise, we report $[[e]]$ fails to type check.
		\item[Case $e=[[castdown e1]]$:] From the premises of rule \ruleref{T\_CastDown}, by induction hypothesis, we can derive the type of $[[e1]]$ as $[[t1]]$. By Lemma \ref{lem:unired}, there is at most one $[[t2]]$ such that $[[t1 --> t2]]$. If such $[[t2]]$ exists and its sorts is either $[[star]]$ or $[[square]]$, we have found the unique type of $[[e]]$ is $[[t2]]$. Otherwise, we report $[[e]]$ fails to type check.
	\end{description}
\end{proof}

\subsection{Soundness}
\begin{dfn}[Multi-step reduction]
    The relation $[[->>]]$ is the transitive and reflexive closure of $[[-->]]$.
\end{dfn}

\begin{lem}[Subject reduction]
If $[[G |- e:T]]$ and $e [[->>]] e'$ then $[[G |- e':T]]$.
\end{lem}

\begin{proof}
    We prove the case for one-step reduction, i.e. $[[e --> e']]$. The lemma can follow by induction on the number of one-step reductions of $e [[->>]] e'$.
    The proof is by induction with respect to the definition of one-step reduction $[[-->]]$ as follows:
    \begin{description}
        \item[Case $\ottdruleSXXBeta{}$:] $\quad$ \\
        Suppose $[[G |- (\x:t1.e1)e2 :T]]$ and $[[G |- e1 [x |-> e2] :T']]$. By Lemma \ref{lem:gen}(2), there exist expressions $[[t1']]$ and $[[t2]]$ such that 
        \begin{align}
            &[[G |- (\x:t1.e1):(Pi x:t1'.t2)]] \label{equ:lam} \\
            &[[G |- e2:t1']] \nonumber \\
            &[[T =a t2 [x |-> e2] ]] \nonumber
        \end{align}
        By Lemma \ref{lem:gen}(3), the judgement (\ref{equ:lam}) implies that there exists an expression $[[t2']]$ such that
        \begin{align}
            &[[Pi x:t1'.t2 =a Pi x:t1.t2']] \label{equ:lameq}\\
            &[[G, x:t1 |- e1:t2']] \nonumber
        \end{align}
        Hence, by (\ref{equ:lameq}) we have $[[t1 =a t1']]$ and $[[t2 =a t2']]$. Then we can obtain $[[G, x:t1 |- e1:t2]]$ and $[[G |- e2:t1]]$. By Lemma \ref{lem:subst}, we have $[[G |- e1[x |-> e2] : t2[x |-> e2] ]]$. Therefore, we conclude with $[[T' =a t2[x |-> e2] ]] [[=a]] [[T]]$.
        
        \item[Case $\ottdruleSXXApp{}$:] $\quad$ \\
        Suppose $[[G |- e1 e2 :T]]$ and $[[G |- e1' e2 :T']]$. By Lemma \ref{lem:gen}(2), there exist expressions $[[t1]]$ and $[[t2]]$ such that 
        \begin{align*}
            &[[G |- e1:(Pi x:t1.t2)]] \\
            &[[G |- e2:t1]]\\
            &[[T =a t2 [x |-> e2] ]]
        \end{align*}
        By induction hypothesis, we have $[[G |- e1':(Pi x:t1.t2)]]$. By rule \ruleref{T\_App}, we obtain $[[G |- e1' e2 : t2[x |-> e2] ]]$. Therefore, $[[T' =a t2[x |-> e2] ]] [[=a]] [[T]]$.
        
        \item[Case $\ottdruleSXXCastDown{}$:] $\quad$ \\
        Suppose $[[G |- castdown e :T]]$ and $[[G |- castdown e' :T']]$. By Lemma \ref{lem:gen}(7), there exist expressions $[[t1]], [[t2]]$ and a sort $s$ such that 
        \begin{align*}
            &[[G |- e:t1]] \qquad [[G |- t2:s]] \\
            &[[t1 --> t2]] \qquad [[T =a t2 ]]
        \end{align*}
        By induction hypothesis, we have $[[G |- e':t1]]$. By rule \ruleref{T\_CastDown}, we obtain $[[G |- castdown e' : t2 ]]$. Therefore, $[[T' =a t2]] [[=a]] [[T]]$.
        
        \item[Case $\ottdruleSXXCastDownUp{}$:] $\quad$ \\
        Suppose $[[G |- castdown (castup [t1] e) :T]]$ and $[[G |- e :T']]$. By Lemma \ref{lem:gen}(7), there exist expressions $[[t1']], [[t2]]$ such that 
        \begin{align}
            &[[G |- (castup [t1] e):t1']] \label{equ:fold} \\
            &[[t1' --> t2]] \label{equ:foldeq1} \\
            &[[T =a t2 ]] \label{equ:foldeq4}
        \end{align}
        By Lemma \ref{lem:gen}(6), the judgement (\ref{equ:fold}) implies that there exists an expression $[[t2']]$ such that
        \begin{align}
            &[[G |- e:t2']] \label{equ:foldr} \\
            &[[t1 --> t2']] \label{equ:foldeq2} \\
            &[[t1' =a t1]] \label{equ:foldeq3}
        \end{align}
        By (\ref{equ:foldeq1}, \ref{equ:foldeq2}, \ref{equ:foldeq3}) and Lemma \ref{lem:unired} we obtain $[[t2 =a t2']]$. From (\ref{equ:foldr}) we have $[[T' =a t2' ]]$. Therefore, by (\ref{equ:foldeq4}), $[[T' =a t2' ]] [[=a]] [[t2 =a T]]$.
        
        \item[Case $\ottdruleSXXMu{}$:] $\quad$ \\
        Suppose $[[G |- (mu x:t.e) :T]]$ and $[[G |- e[x |-> mu x:t.e] :T']]$. By Lemma \ref{lem:gen}(5), we have $[[T =a t]]$ and $[[G, x:t |- e:t]]$. Then we obtain $[[G |- (mu x:t.e) : t]]$. Thus by Lemma \ref{lem:subst}, we have $[[G |- e[x |-> mu x:t.e] : t[x |-> mu x:t.e] ]]$.
        
        Note that $x:[[t]]$, i.e. the type of $x$ is $[[t]]$, then $x \notin \FV([[t]])$ holds implicitly. Hence, by the definition of substitution, we obtain $[[t[x |-> mu x:t.e] == t]]$. Therefore, $[[T' =a t[x |-> mu x:t.e] ]] [[==]] [[t =a T]]$.
    \end{description}
\end{proof}

\begin{lem}[Progress]
If $[[|- e:T]]$ then either $e$ is a value $v$ or there exists $e'$ such that $[[e --> e']]$.
\end{lem}

\begin{proof}
    By induction on the derivation of $[[|- e:T]]$ as follows:
    \begin{description}
        \item[Case $e=[[star]]$:] Trivial by rule \ruleref{T\_Ax} where $[[T == square]]$.
        \item[Case $e=x$:] Impossible, since the context is empty.
        \item[Case $e=v$:] Trivial, since $e$ is already a value that has one of the following forms:
		\begin{inparaenum}[(1)]
			\item $[[\x:t.e]]$,
			\item $[[Pi x:t1.t2]]$,
			\item $[[castup [t] e]]$.
		\end{inparaenum}
		\item[Case $e=[[e1 e2]]$:] By Lemma \ref{lem:gen}(2), there exist expressions $[[t1]]$ and $[[t2]]$ such that $[[|- e1:(Pi x:t1.t2)]]$ and $[[|-e2:t1]]$. Consider whether $[[e1]]$ is a value:
    		\begin{itemize}
    		    \item If $[[e1]]=v$, by Lemma \ref{lem:gen}(3), it must be a $\lambda$-term such that $[[e1 == \x:t1.e1']]$ for some $[[e1']]$ satisfying $[[|- e1':t2]]$. Then by rule \ruleref{S\_Beta}, we have $[[(\x:t1.e1') e2 --> e1' [x |-> e2] ]]$. Thus, there exists $[[e' == e1' [x |-> e2] ]]$ such that $[[e --> e']]$.
    		    \item Otherwise, by induction hypothesis, there exists $[[e1']]$ such that $[[e1 --> e1']]$. Then by rule \ruleref{S\_App}, we have $[[e1 e2 --> e1' e2]]$. Thus, there exists $[[e' == e1' e2]]$ such that $[[e --> e']]$.
    		\end{itemize}
		\item[Case $e=[[castdown e1]]$:] By Lemma \ref{lem:gen}(7), there exist expressions $[[t1]]$ and $[[t2]]$ such that $[[|- e1:t1]]$ and $[[t1 --> t2]]$. Consider whether $[[e1]]$ is a value:
		     \begin{itemize}
    		    \item If $[[e1]]=v$, by Lemma \ref{lem:gen}(6), it must be a $[[castup]]$-term such that $[[e1 == castup [t1] e1']]$ for some $[[e1']]$ satisfying $[[|- e1':t2]]$. Then by rule \ruleref{S\_CastDownUp}, we can obtain $[[castdown (castup [t1] e1') --> e1']]$. Thus, there exists $[[e' == e1']]$ such that $[[e --> e']]$.
    		    \item Otherwise, by induction hypothesis, there exists $[[e1']]$ such that $[[e1 --> e1']]$. Then by rule \ruleref{S\_CastDown}, we have $[[castdown e1 --> castdown e1']]$. Thus, there exists $[[e' == castdown e1']]$ such that $[[e --> e']]$.
    		\end{itemize}
		\item[Case $e=[[mu x:t.e1]]$:] By rule \ruleref{S\_Mu}, there always exists $[[e' == e1[x |-> mu x:t.e1] ]]$.
    \end{description}
\end{proof}

